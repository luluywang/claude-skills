# Compile LaTeX Task

**Purpose:** Assemble all draft responses into a single LaTeX response document matching the user's format.

---

## Input

- **Config:** `current/config.json` — input paths, round number
- **Triage:** `current/triage.json` — comment order, sources, clusters
- **Responses:** `current/responses/*.md` — all draft responses
- **Verification:** `current/verification/*.json` — per-comment claim check results
- **Template:** `revisions/templates/response_document.tex` — document skeleton
- **LaTeX template prompt:** `revisions/prompts/components/latex_template.prompt` — formatting rules
- **Prior response:** (if available) — for extracting custom commands and style

## Task

Assemble a complete LaTeX document that contains all referee comments and responses.

### Step 1: Determine Document Structure

Read the template and prior response (if available) to determine:
- Document class and preamble
- Custom commands (e.g., `\editorcomment`, `\summarizechangeeditor`, `\refereeletter`)
- Bibliography resource path
- Page numbering convention
- Section ordering

### Step 2: Build Document Sections

The document has this structure:

```latex
% Preamble
\documentclass[main.tex]{subfiles}
\addbibresource{...}
\begin{document}

% Custom commands (from prior response or template)

% Opening letter to editor
Dear Professor [Editor Name],
...

% Summary of Main Changes
\section*{Summary of the Main Changes}
\begin{enumerate}
  \item \textbf{Theme 1.} Summary of changes...
  ...
\end{enumerate}

% Detailed Response to Editor Letter
\begin{refsection}
\section*{Detailed Response to the Editor Letter}

\begin{refcommentnoclear}
  [editor comment 1 text]
\end{refcommentnoclear}
\textbf{Reply:} [response text]

...
\printbibliography
\end{refsection}

% Detailed Response to Referee 1
\begin{refsection}
\section*{Detailed Response to Referee 1}
[referee letter opening, if using \refereeletter command]

\begin{refcommentnoclear}
  [referee 1 comment 1 text]
\end{refcommentnoclear}
\textbf{Reply:} [response text]

...
\printbibliography
\end{refsection}

% Repeat for each referee
...

\end{document}
```

### Step 3: Process Each Response

For each response in `current/responses/{id}.md`:

1. Extract the "Original Comment" section → wrap in `\begin{refcommentnoclear}...\end{refcommentnoclear}`
2. Extract the "Draft Response" section → place after `\textbf{Reply:}`
3. Strip markdown formatting, preserve LaTeX commands
4. Order comments by their number within each referee section

### Step 4: Generate Summary of Main Changes

From the triage clusters and high-priority responses, generate a summary:
- Group by thematic cluster
- Each cluster becomes a `\textbf{Theme.}` item in the enumerate
- Reference which referees' concerns each theme addresses

If the user's prior response has a `\summarizechangeeditor` command, use the same structure.

### Step 5: Handle Verification Issues

For responses with verification issues:
- Include the response as-is (user will fix)
- Add a LaTeX comment `% [VERIFY]` before problematic references
- Preserve any [TODO] markers in the text

### Step 6: Write Output

Save the compiled document to:
- If manuscript path is known: same directory as manuscript, named `response_round{N}.tex`
- Otherwise: `current/response_round{N}.tex`

## Formatting Rules

1. **Comment environments:** Always use `\begin{refcommentnoclear}...\end{refcommentnoclear}`
2. **Reply marker:** Always use `\textbf{Reply:}` (with space after colon)
3. **Section breaks:** Use `\clearpage` between major sections (editor, each referee)
4. **Bibliography:** Each `refsection` ends with `\printbibliography`
5. **No rewriting:** Use the draft response text as-is. Do not paraphrase or "improve" it.
6. **Preserve LaTeX:** All `\ref{}`, `\textcite{}`, `\parencite{}`, `\scalarinput{}` commands pass through unchanged.
7. **Comment text verbatim:** The referee's original comment text goes inside `refcommentnoclear` exactly as extracted during parsing.
8. **Page numbering:** Match the convention from the prior response (e.g., `E-\arabic{page}` for editor).

## Output

Return:
```json
{
  "output_path": "/path/to/response_round2.tex",
  "referee_count": 4,
  "comment_count": 42,
  "todo_count": 5,
  "verification_issues": 2
}
```
