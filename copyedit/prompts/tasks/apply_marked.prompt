# Task: Apply Marked Changes

**Model:** Haiku (simple parsing and batch edits)

**Purpose:** Batch-apply all user-approved changes marked with `[x]` in checklist files.

**Input:** All `notes/*.md` files with checklist format (auto-scanned)

**Output:**
- Modified .tex files with accepted changes applied
- Summary of changes applied

---

## Checklist Files to Scan

Automatically scan these files in `notes/`:
- `ai_detection.md`
- `simplifications.md`
- `word_choice_review.md`
- `sentence_analysis.md`
- `structure_analysis.md`
- `methodology_review.md`

**Skip:** `copy_edits.md` (grammar log format â€” already auto-applied)

---

## Expected Checklist Format

Each file contains sections by source file, with checklist items:

```markdown
## filename.tex

### - [x] Lines X-Y: [Brief description]

**Comment:** [Why this change was suggested]

**Original:**
```
[Original text from .tex file]
```

**Proposed Revision:**
```
[Replacement text]
```

**Why better:** [Explanation]
```

**Key markers:**
- `- [x]` = User approved, apply this change
- `- [x] ... (applied)` = Already applied, skip
- `- [ ]` = Not approved, skip
- `- [-]` = Rejected, skip
- `## filename.tex` = Target file for subsequent items

---

## Workflow

### Step 1: Scan for Marked Items

1. Glob `notes/*.md` (exclude `copy_edits.md`)
2. For each file, extract items where:
   - Checkbox is `[x]` (case-insensitive)
   - Line description does NOT contain `(applied)`
3. For each marked item, extract:
   - **Source file**: The notes/*.md file it came from
   - **Full header line**: e.g., `### - [x] Lines 23-25: Hedging`
   - **Target file**: From `## filename.tex` section header
   - **Lines**: From `Lines X-Y` in item header
   - **Original**: Content of Original code block
   - **Proposed**: Content of Proposed Revision code block

### Step 2: Validate Extractions

For each extracted item, verify:
- Target file exists
- Original text can be found in target file (approximate match OK for whitespace)
- Proposed text is different from Original

**If validation fails:**
- Log the issue
- Skip the item
- Continue processing others

### Step 3: Deduplicate

If the same target file + line range appears in multiple checklist files:
- Keep only one (prefer first encountered)
- Log duplicate found

### Step 4: Group and Sort

1. Group all validated items by target file
2. Within each file, sort by line number **descending** (highest first)

**Why descending?** Applying edits from bottom to top preserves line numbers for earlier edits.

### Step 5: Apply Edits

**First:** Check `notes/tasks.json` for the `llm_tagging` setting.

For each target file:
1. Read current file content
2. For each edit (in descending line order):
   - Determine `new_string` based on LLM tagging:
     - If `llm_tagging: true` AND file is `.tex`: `new_string` = `\begin{llm}` + Proposed + `\end{llm}`
     - If `llm_tagging: false` OR file is not `.tex`: `new_string` = Proposed (unchanged)
   - Use Edit tool: `old_string` = Original, `new_string` = (as determined above)
   - If Edit fails (text not found exactly), try with normalized whitespace
   - Log success or failure
3. Continue until all edits for file complete

### LLM Tagging Example

**Without tagging:**
```
Edit: old_string = "the affect on prices", new_string = "the effect on prices"
```

**With tagging (llm_tagging: true):**
```
Edit: old_string = "the affect on prices", new_string = "\begin{llm}the effect on prices\end{llm}"
```

### Step 6: Mark Items as Applied

**CRITICAL:** After successfully applying an edit, update the source markdown file to add `(applied)` suffix.

For each successfully applied edit:
1. Find the header line in the source notes/*.md file
2. Append `(applied)` to the line description
   - Before: `### - [x] Lines 23-25: Hedging`
   - After: `### - [x] Lines 23-25: Hedging (applied)`
3. Use Edit tool on the markdown file

**Why this matters:** Prevents re-application if user runs apply_marked again. Also enables interoperability with interactive_review.

### Step 7: Report Summary

```
## Apply Marked Changes Summary

**Total marked items found:** N (across M checklist files)
**Successfully applied:** X
**Skipped (validation failed):** Y
**Skipped (edit failed):** Z

### Changes by Target File

**intro.tex:** 5 changes applied
- Line 23: Hedging reduction
- Line 45: Meta-commentary removed
- Line 89: Word choice improvement
...

**methods.tex:** 3 changes applied
...

### Issues (if any)

- simplifications.md Line 34: Original text not found in intro.tex
- ai_detection.md Line 89: Duplicate of word_choice_review.md Line 45, skipped
```

---

## Edge Cases

### Empty Result
If no `[x]` items found:
```
No marked changes found in notes/*.md files.

To mark changes for application:
1. Open the checklist file (e.g., notes/simplifications.md)
2. Change `- [ ]` to `- [x]` for items you want applied
3. Run this task again
```

### Partial Failures
- Continue applying other changes even if some fail
- Report all failures in summary
- Don't rollback successful changes

### Whitespace Differences
If exact Original text not found, try:
1. Normalize whitespace (collapse multiple spaces, trim)
2. Try matching first line only for multi-line blocks
3. If still no match, report failure and skip

---

## Quality Control

- [ ] All `notes/*.md` files scanned (except copy_edits.md)
- [ ] Only `[x]` items WITHOUT `(applied)` processed
- [ ] Items with `(applied)` or `[-]` skipped
- [ ] Edits applied in reverse line order per file
- [ ] Successfully applied items marked with `(applied)` suffix in markdown
- [ ] All changes logged in summary
- [ ] Failed edits reported with reason
